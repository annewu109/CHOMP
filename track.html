<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHOMP - Track</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            height: 100%;
            margin: 0;
            background: darkseagreen;
        }
        .order-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .order-title {
            text-align: center;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="page-top">
        <a id="logo-link" href="index.html"><img id="logo" src="CHOMP-logo.png"></a>
            <h1 class="header">CHOMP</h1>
            <!-- <h3 class="header">
                <strong>C</strong>onsumer <strong>H</strong>ealth <strong>O</strong>riented <strong>M</strong>eal <strong>P</strong>repping
            </h3> -->
    </div>
    <div class="nav-bar">
        <ul>
            <li><a href="about.html">About</a></li>
            <li><a href="contact.html">Contact</a></li>
            <li><a href="subscriptions.html">Plans</a></li>
        </ul>
    </div>

    <div class="order-container" id="orderContainer">
        <h2 class="order-title">Your Order</h2>

        <div class="order-status">
            <h3>Status: <span id="orderStatus">Looking for a deliverer...</span></h3>
        </div>

        <h3 id="orderName" class="order-title"></h3>
        <div class="ingredients-section">
            <h3 class="section-title">Ingredients</h3>
            <ul class="ingredient-list" id="ingredientList">
                <!-- Ingredients will be loaded here -->
            </ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const mealId = urlParams.get('meal_id');
            
            if (mealId) {
                fetchOrderDetails(mealId);
            } else {
                document.getElementById('orderContainer').innerHTML = `
                    <h2>No order found</h2>
                    <p>Please close this window and place an order from our menu.</p>
                `;
            }
        });

        function fetchOrderDetails(mealId) {
            fetch(`get_recipe_details.php?meal_id=${mealId}`)
                .then(response => response.json())
                .then(data => {
                    displayOrderDetails(data);
                    sendOrderDetails(data.ingredients.map(ingredient => ingredient.name))
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('orderContainer').innerHTML = `
                        <h2>Error loading order</h2>
                        <p>${error.message}</p>
                    `;
                });
        }

        async function sendOrderDetails(ingredients) {
            const user = await fetch(`https://chomp-apis-8eaf05731f53.herokuapp.com/profile/${localStorage.getItem('userId')}`);
            const userData = await user.json();
            
            if (!userData.inOrder) {
                const response = await fetch('https://chomp-apis-8eaf05731f53.herokuapp.com/order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ingredients: ingredients,
                        userId: localStorage.getItem('userId'),
                        address: userData.address
                    })
                });

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.message || 'Failed to submit order');
                }

                localStorage.setItem('currentOrderId', data.orderId);
            }

            checkOrderStatus();
        }

        async function checkOrderStatus() {
            if (!localStorage.getItem('currentOrderId')) {
                return;
            }
            
            try {
                const response = await fetch(`https://chomp-apis-8eaf05731f53.herokuapp.com/order/status/${localStorage.getItem('currentOrderId')}`);
                const data = await response.json();
                
                if (data.status === 'delivered') {
                    document.getElementById('orderStatus').textContent = 'Order delivered!';
                    document.getElementById('orderStatus').className = 'delivered';
                } else if (data.status === 'accepted') {
                    document.getElementById('orderStatus').textContent = 'Accepted by deliverer! Waiting for delivery...';
                    document.getElementById('orderStatus').className = 'accepted';
                    
                    // check every 2 seconds
                    setTimeout(checkOrderStatus, 2000);
                } else {
                    document.getElementById('orderStatus').textContent = 'Pending...';
                    document.getElementById('orderStatus').className = 'pending';
                    
                    // check every 2 seconds
                    setTimeout(checkOrderStatus, 2000);
                }
            } catch (error) {
                console.error('Error checking order status:', error);
                document.getElementById('orderStatus').textContent = 'Error checking status';
                document.getElementById('orderStatus').className = 'error';
            }
        }

        function displayOrderDetails(data) {
            document.getElementById('orderName').textContent = data.meal.name;
            
            const ingredientList = document.getElementById('ingredientList');
            ingredientList.innerHTML = '';
            
            data.ingredients.forEach(ingredient => {
                const li = document.createElement('li');
                li.className = 'ingredient-item';
                li.innerHTML = `
                    <span>${ingredient.quantity_required} ${ingredient.unit} ${ingredient.name}</span>
                    <span>${ingredient.calories_per_unit * ingredient.quantity_required} cal</span>
                `;
                ingredientList.appendChild(li);
            });
        }
    </script>
</body>
</html>
